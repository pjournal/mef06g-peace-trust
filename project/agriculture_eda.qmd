---
title: "Group Project: Agriculture in Turkey - EDA"
date: "3 December 2022"
title-block-banner: "#008000"
format:
  html:
    toc: true
    toc-depth: 3
    toc-float: true
    number-sections: false
---

![Tarım](tarim.jpg)

```{=html}
<style>
    body { 
    font-family: Calibri;
    text-align: justify;
    font-size: 11pt;
    div.hidecode + pre {display: none}
    }
</style>
```
::: hidecode
```{r setup, output=FALSE,echo=FALSE,warning = FALSE}
knitr::opts_chunk$set(warning = FALSE)
Sys.setlocale(locale = "en_US.UTF-8")
options(dplyr.summarise.inform = FALSE)
options(scipen=999)
```
:::

Agriculture in Turkey - EDA is the part 2 of the Group Project: Agriculture in Turkey

We start by  loading our dataset that we prepare in the **Group Project: Agriculture in Turkey - Preprocessing**



#### Call necessary libraries

```{r call_libraries, warning=  FALSE,  message = FALSE}
#install.packages("readxl")
#install.packages("ggrepel")
library(readxl)
library(lubridate)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(tidyr)
library(ggrepel)
```


## Load the Data
```{r}
# Prepare data
tarim <- readRDS("data//tarim.rds")
meyve <- readRDS("data//meyve.rds")
sebze <- readRDS("data//sebze.rds")
tahil <- readRDS("data//tahil.rds")
```

## Total Agriculture Areas 

### Agriculture areas are shrinking slightly

```{r}
df <- tarim %>%
  group_by(year) %>%
  summarise(TotalAgricultureDecare=sum(decare))

ggplot(data=df, aes(x=year, y=TotalAgricultureDecare)) +
  geom_line() + 
  ylim(220000000,max(df$TotalAgricultureDecare))+
  ggtitle("Total Agriculture Areas(Decare) By Year")

```
Between 2010-2011, biggest agricultural area lost is happened. In 2011-2015, it seems to be good years for Agriculture in terms of magnitude of the areas.
However, after 2015, general trend moves towards to losing the Agricultural areas, after 2019 there seems to be first improvement, interestingly first improvement is in 2020, "the pandemic year" but in general in 11 years, size of the agricultural areas moving downwards.

### Yearly agriculture areas 

Add previous decares to the dataframe
```{r}
df_1 <- tarim %>% 
  arrange(province, year) %>% 
  group_by(province) %>% 
  mutate(prev_decare = lag(decare)) %>% 
  ungroup()
head(df_1)
```
If we look at year by year lost, the biggest lost was in Sivas, 2011 with 2.290.480 decare loss.
Second is Kars with 1.628.918, third is Konya with 1.526.849. However, Konya's total agriculture areas are greater than others. Rate of yearly difference and decare will be another indicator.

```{r}
df_1 <- df_1 %>%
  mutate(difference = (decare-prev_decare))%>%
  arrange(desc(-1*difference))

head(df_1)
```
If we sort according to rate of difference Ardahan,2014 is the first with 0.79, Kars,2013 and Karabük,2018 are the second and Third in terms of yearly agriculture area lost. 
```{r}
df_1 <- df_1 %>%
  mutate(difference_rate = round(difference/decare,2))%>%
  arrange((difference_rate))


head(df_1)
```
Interestingly, yearly loss is greater in the first half of the decade, but overall loss is increasing year by year, let's visualise this by adding cumulative loss column.

If we look at total lost, Şanlıurda, Konya ans Sivas are the three big cities
```{r}
df_p <- df_1 %>%
  group_by(province) %>%
  summarise('TotalDifference'=sum(difference, na.rm=TRUE),'TotalRate'=sum(difference_rate, na.rm=TRUE)) %>%
  arrange(TotalDifference)

knitr::kable(head(df_p),caption = "Total Agriculture Lost Areas by Province 2010-2021")

```
```{r}

df_p <- df_p %>%
  arrange(TotalDifference) %>%
  mutate(TotalDifference=TotalDifference*-1)

ggplot(data=head(df_p,10), aes(x=province, y=TotalDifference)) +
  geom_bar(position="dodge",stat="identity") + 
  ggtitle("Total Agriculture Area Loss by Province 2010-2021 - Top 10 Province") +
  theme(text = element_text(size = 10),element_line(size =15),axis.text.x = element_text(angle = 90))


```
**Zonguldak lost almost half of the agricultural areas in 11 years**

```{r}
df_p <- df_p %>%
  arrange(TotalRate)

knitr::kable(head(df_p),caption = "Total Agriculture Lost Areas by Province 2010-2021")

```
```{r}
df_o <- df_1 %>%
  group_by(province) %>%
  summarise('TotalYearlyDifferenceRate'=sum(difference_rate, na.rm=TRUE)) %>%
  arrange(TotalYearlyDifferenceRate) %>%
  mutate(TotalYearlyDifferenceRate=-1*TotalYearlyDifferenceRate)

ggplot(head(df_o,10), aes(x=province, y=TotalYearlyDifferenceRate)) +
  geom_bar(position="dodge",stat="identity") + 
  ggtitle("Total Agriculture Area Loss Rate by Province 2010-2021") +
  theme(axis.text.x = element_text(angle = 90))


```



### Distribution of Agricultural Production

### Fruits


```{r warning=FALSE}

meyve_dekar <-
  meyve %>% 
  filter(year==2021 & unit=='Dekar')


total = sum(meyve_dekar[, 'production'],na.rm=TRUE)

grouped_data <- meyve_dekar %>%
  group_by(product_name) %>%
  summarise(TotalbyName = sum(production,na.rm=TRUE)) %>%
  mutate(rate = round((TotalbyName/total)*100),2)

plot_data <- grouped_data %>%
  mutate(rank = rank(-TotalbyName), 
         product_name = ifelse(rank <= 10, product_name, 'Other'))

ggplot(plot_data, aes(x="", y=rate, fill=product_name)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) + 
  geom_label_repel(data = plot_data,
                   aes(y = rate, label = paste0(product_name, rate,"%")),
                   size = 5, nudge_x = 1, show.legend = FALSE) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid  = element_blank())+ 
  labs(x ="",y="") +
  ggtitle("Top 10 Fruit Products (in Decare) in Turkey in 2021")
```

### Vegetables
```{r warning=FALSE}

sebze_df <- sebze %>%
  filter(year==2021 & unit=='Dekar')

total = sum(sebze_df [, 'decare'],na.rm=TRUE)

grouped_data <- sebze %>%
  filter(year==2021 & unit=='Dekar') %>%
  group_by(product_name) %>%
  summarise(TotalbyName = sum(decare,na.rm=TRUE)) %>%
  mutate(rate = round((TotalbyName/total)*100),4)

plot_data <- grouped_data %>%
  mutate(rank = rank(-TotalbyName), 
         product_name = ifelse(rank <= 10, product_name, 'Other'))

ggplot(plot_data, aes(x="", y=rate, fill=product_name)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) + 
  geom_label_repel(data = plot_data,
                   aes(y = rate, label = paste0(product_name, rate,"%")),
                   size = 5, nudge_x = 1, show.legend = FALSE) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid  = element_blank())+ 
  labs(x ="",y="") +
  ggtitle("Top 10 Vegetable Products (in Decare) in Turkey  in 2021")

```
### Grain
```{r warning=FALSE}
tahil_df <-  tahil %>%
  filter(year==2021 & unit=='Dekar')

total = sum(tahil_df[, 'decare'],na.rm=TRUE)

grouped_data <- tahil %>%
  filter(year==2021 & unit=='Dekar') %>%
  group_by(product_name) %>%
  summarise(TotalbyName = sum(decare,na.rm=TRUE)) %>%
  mutate(rate = round((TotalbyName/total)*100),2)

plot_data <- grouped_data %>%
  mutate(rank = rank(-TotalbyName), 
         product_name = ifelse(rank <= 10, product_name, 'Other'))

ggplot(plot_data, aes(x="", y=rate, fill=product_name)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) + 
  geom_label_repel(data = plot_data,
                   aes(y = rate, label = paste0(product_name, rate,"%")),
                   size = 5, nudge_x = 1, show.legend = FALSE) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid  = element_blank())+ 
   labs(x ="",y="") +
  ggtitle("Top 10 Grain Products(as Decare) in Turkey in 2021")
```

### Yearly Grain/Fruit/Vegetable Production Areas 

Grain production areas were decreasing until 2019, after 2019, it is increasing slightly like agricultural areas

```{r}
df_gra <- tahil %>%
  filter(unit=='Dekar') %>%
  group_by(year)%>%
  summarize(total_gra_decare = sum(decare, na.rm = TRUE)) %>%
  mutate(prev_decare = lag(total_gra_decare)) %>%
  mutate(diff_gra_rate = round((total_gra_decare-prev_decare)/total_gra_decare,2))

ggplot(data=df_gra, aes(x=year, y=total_gra_decare)) + 
  geom_line() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  labs(x ="Year",y="Decare") +
  ggtitle("Total Grain Agriculture Areas(Decare) Between 2010-2021")

```
Fruit production areas are increasing slightly unlike agricultural areas

```{r}

df_meyve <- meyve %>%
  filter(unit=='Dekar') %>%
  group_by(year)%>%
  summarize(total_gra_decare = sum(production, na.rm = TRUE)) %>%
  mutate(prev_decare = lag(total_gra_decare)) %>%
  mutate(diff_gra_rate = round((total_gra_decare-prev_decare)/total_gra_decare,2))

ggplot(data=df_meyve, aes(x=year, y=total_gra_decare)) + 
  geom_line() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  labs(x ="Year",y="Decare") +
  ggtitle("Total Fruit Agriculture Areas(Decare) Between 2010-2021")

```
```{r}
meyve_sort <- meyve %>% arrange(year)

meyve_analiz <- meyve_sort %>%
  filter(unit=='Dekar') %>%
  group_by(year,product_name)%>%
  summarize(total_decare = sum(production, na.rm = TRUE)) %>%
  arrange(product_name,year) %>%
  ungroup() 


meyve_sort_analiz <- meyve_analiz %>%
  mutate(prev_dekar=lag(total_decare))  %>%
  mutate(difference_with_prev_year =total_decare-prev_dekar ) %>%
  filter(year>2010) %>%
  arrange(desc(difference_with_prev_year))

knitr::kable(head(meyve_sort_analiz),caption = "The Top Fruits in Terms of Yearly Increased Agricultural Areas ")


```


```{r}

df_sebze <- sebze %>%
  filter(unit=='Dekar') %>%
  group_by(year)%>%
  summarize(total_gra_decare = sum(decare, na.rm = TRUE)) %>%
  mutate(prev_decare = lag(total_gra_decare)) %>%
  mutate(diff_gra_rate = round((total_gra_decare-prev_decare)/total_gra_decare,2))

ggplot(data=df_sebze, aes(x=year, y=total_gra_decare)) + 
  geom_line() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  labs(x ="Year",y="Decare") +
  ggtitle("Total Vegetable Agriculture Areas(Decare) Between 2010-2021")

```
**Above analysis show that, increase in the agricultural areas after 2019 due to fruit (mostly nuts) and grain production**

## Climate Indicators and Agrriculture Areas

In this section we will compare the yearly average temperatures with the agriculture areas. Weather data is gathered from [TradingEconomics](https://tradingeconomics.com/turkey/temperature). 

Increase in average temperature in Turkey in 2018, also coincides with the decrease in Agriculrural area. Note that we need further statistical tests to show the relation between, this presentations only shows the raw data.

```{r}
temperature = read_excel("data//temp.xlsx")


df <- tarim %>%
  group_by(year) %>%
  summarise(TotalDecareNormalized=sum(decare)/ 20000000)


df_t <- df %>%
  inner_join(temperature)
  
ggplot(df_t, aes(year)) + 
  geom_line(aes(y = TotalDecareNormalized, colour = "Total Decare (1/20000000)")) + 
  geom_line(aes(y = temperature, colour = "Temperature")) +
  ylab(NULL) +
  ggtitle("Average Temperature vs Total Agricultural Area") 
```
CO2 emission is also an important metric for measuring the climate change. CO2 emissions (metric tons per capita)	Carbon dioxide emissions are those stemming from the burning of fossil fuels and the manufacture of cement. They include carbon dioxide produced during consumption of solid, liquid, and gas fuels and gas flaring.
WorldBank launches the CO2 emissions (metric tons per capita) data for every country. I used [WorldBank](CO2 emissions (metric tons per capita) )

Note that, Data consists of the CO2 emission for 2009-2019
```{r warning=FALSE}
co2 = read_excel("data//co2.xlsx")


df_t$year<-as.character.Date(df_t$year)
df_t_c <- df_t %>%
  inner_join(co2, by='year')

ggplot(df_t_c, aes(year)) + 
  geom_line(aes(y = TotalDecareNormalized, colour = "Total Decare (1/20000000)", group=1)) + 
  geom_line(aes(y = CO2emissions, colour = "CO2 Emission(Ton Per Capita)", group=2)) +
  geom_line(aes(y = temperature, colour = "Temperature", group=3)) +
  ylab(NULL) +
  ggtitle("Average Temperature, CO2 Emission and Total Agricultural Area in Turkey")  

```
## Most efficient Fruits in Turkey

Production in kg per tree is as follows, is seems Apple is the winner here too.

```{r}
df_e <- meyve %>%
  filter(str_trim(unit)=='Kg/Meyve Veren Ağaç')%>%
  group_by(product_name,unit) %>%
  summarise(toplam = sum(production, na.rm = TRUE)) %>%
  arrange(desc(toplam))

knitr::kable(head(df_e),caption = "Fruit Efficiency (KG % Per Tree)")
```
Let's group all fruits containing "Elma" under the Elma.

```{r}
meyve_group <- meyve

meyve_group$product_name <- gsub(".*Elma.*", "Elma", meyve$product_name)


df_elma <- meyve_group %>%
  filter(str_trim(unit)=='Kg/Meyve Veren Ağaç')%>%
  group_by(product_name,unit) %>%
  summarise(toplam = sum(production, na.rm = TRUE)) %>%
  arrange(desc(toplam))

ggplot(data=df_elma, aes(x=product_name, y=toplam)) +
  geom_bar(position="dodge",stat="identity") + 
  ggtitle("Fruit Efficiency (KG % Per Tree)") +
  theme(text = element_text(size = 10),element_line(size =15),axis.text.x = element_text(angle = 90))

```


